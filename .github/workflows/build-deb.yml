name: Build Deb Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Haskell
        uses: haskell-actions/setup@v2
        with:
          enable-stack: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev libsdl2-mixer-dev

      - name: Build
        run: stack build --copy-bins --local-bin-path ./

      - name: Package
        run: |
          # Use tag version if available, otherwise use 0.0.0-dev
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF_NAME#v}
          else
            VERSION="0.0.0-dev"
          fi
          mkdir -p .debpkg/usr/local/bin
          mkdir -p .debpkg/usr/share/shark-game
          mkdir -p .debpkg/DEBIAN

          # Copy binary
          cp shark-game-exe .debpkg/usr/local/bin/shark-game
          chmod +x .debpkg/usr/local/bin/shark-game

          # Copy assets
          cp -r assets data .debpkg/usr/share/shark-game/

          # Create control file
          cat > .debpkg/DEBIAN/control << EOF
          Package: shark-game
          Version: $VERSION
          Architecture: amd64
          Maintainer: Lianne Lairmore <lianne.lairmore@gmail.com>
          Description: Shark Institute Game
          Depends: libsdl2-2.0-0, libsdl2-ttf-2.0-0, libsdl2-image-2.0-0
          EOF

          # Build deb
          dpkg-deb --build .debpkg shark-game_${VERSION}_amd64.deb

      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: shark-game_*.deb
