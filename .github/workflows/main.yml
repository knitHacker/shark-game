name: Build Windows
on: [push, pull_request]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: haskell-actions/setup@v2
      with:
        enable-stack: true
        stack-version: 'latest'
    
    - uses: msys2/setup-msys2@v2
      with:
        path-type: inherit    # This is the key!
        update: true
        install: >-
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-SDL2
          mingw-w64-x86_64-SDL2_image
          mingw-w64-x86_64-SDL2_ttf
    
    - name: Cache Stack dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Roaming\stack
          ~\AppData\Local\Programs\stack
          .stack-work
        key: ${{ runner.os }}-stack-${{ hashFiles('stack.yaml', 'shark-game.cabal') }}
        restore-keys: |
          ${{ runner.os }}-stack-
    
    - name: Build
      shell: msys2 {0}
      run: |
        # Build with explicit paths to the MSYS2 where SDL2 was installed
        stack build --copy-bins --local-bin-path . \
          --extra-include-dirs=/mingw64/include \
          --extra-lib-dirs=/mingw64/lib \
          --extra-lib-dirs=/mingw64/bin
    
    - name: Copy DLLs
      shell: msys2 {0}
      run: |
        cp /mingw64/bin/SDL2*.dll .
        cp /mingw64/bin/lib*.dll . 2>/dev/null || true
        ls -la *.dll
    
    - uses: actions/upload-artifact@v4
      with:
        name: shark-game-windows
        path: |
          *.exe
          *.dll
