name: Build Windows
on: [push, pull_request]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: haskell-actions/setup@v2
      with:
        enable-stack: true
        stack-version: 'latest'
    
    - uses: msys2/setup-msys2@v2
      with:
        path-type: inherit    # This is the key!
        update: true
        install: >-
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-SDL2
          mingw-w64-x86_64-SDL2_image
          mingw-w64-x86_64-SDL2_ttf
    
    - name: Copy libssp to GHC MinGW
      shell: msys2 {0}
      run: |
        # Copy libssp from MSYS2 to GHC's MinGW so hsc2hs can find it
        GHC_MINGW="$(stack path --compiler-bin | sed 's|\\|/|g')/../lib"
        echo "Copying libssp to: $GHC_MINGW"
        mkdir -p "$GHC_MINGW"
        cp /mingw64/lib/libssp.* "$GHC_MINGW/" || true
        ls -la "$GHC_MINGW"/libssp.* || echo "No libssp files found"
    
    - name: Build
      shell: msys2 {0}
      run: |
        # Show where SDL2 actually got installed
        echo "SDL2 pkg-config info:"
        pkg-config --cflags --libs sdl2
    
        # Build with explicit paths to MSYS2 libraries
        stack build --copy-bins --local-bin-path . \
          --extra-include-dirs=/mingw64/include \
          --extra-include-dirs=/mingw64/include/SDL2 \
          --extra-lib-dirs=/mingw64/lib \
          --extra-lib-dirs=/mingw64/bin
    
    - name: Copy DLLs
      shell: msys2 {0}
      run: |
        cp /mingw64/bin/SDL2*.dll .
        cp /mingw64/bin/lib*.dll . 2>/dev/null || true
        ls -la *.dll
    
    - uses: actions/upload-artifact@v4
      with:
        name: shark-game-windows
        path: |
          *.exe
          *.dll
