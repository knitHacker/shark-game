name: Build Windows
on: [push, pull_request]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - uses: haskell-actions/setup@v2
      with:
        enable-stack: true
        stack-version: 'latest'

    - name: Download SDL2 binaries
      shell: bash
      run: |
        curl -L https://github.com/libsdl-org/SDL/releases/download/release-2.30.0/SDL2-devel-2.30.0-mingw.tar.gz -o SDL2.tar.gz
        curl -L https://github.com/libsdl-org/SDL_image/releases/download/release-2.8.2/SDL2_image-devel-2.8.2-mingw.tar.gz -o SDL2_image.tar.gz
        curl -L https://github.com/libsdl-org/SDL_ttf/releases/download/release-2.22.0/SDL2_ttf-devel-2.22.0-mingw.tar.gz -o SDL2_ttf.tar.gz
        tar xzf SDL2.tar.gz
        tar xzf SDL2_image.tar.gz
        tar xzf SDL2_ttf.tar.gz
        mkdir -p sdl2-install
        cp -r SDL2-*/x86_64-w64-mingw32/* sdl2-install/
        cp -r SDL2_image-*/x86_64-w64-mingw32/* sdl2-install/
        cp -r SDL2_ttf-*/x86_64-w64-mingw32/* sdl2-install/

    - name: Create pkg-config files
      shell: bash
      run: |
        mkdir -p sdl2-install/lib/pkgconfig
        SDL_DIR=$(cygpath -w "$PWD/sdl2-install")
        cat > sdl2-install/lib/pkgconfig/SDL2_image.pc << EOF
        prefix=$SDL_DIR
        exec_prefix=\${prefix}
        libdir=\${exec_prefix}/lib
        includedir=\${prefix}/include/SDL2

        Name: SDL2_image
        Description: image loading library for Simple DirectMedia Layer
        Version: 2.8.2
        Requires: sdl2 >= 2.0.0
        Libs: -L\${libdir} -lSDL2_image
        Cflags: -I\${includedir} -D_SDL_main_h
        EOF
        
        cat > sdl2-install/lib/pkgconfig/SDL2_ttf.pc << EOF
        prefix=$SDL_DIR
        exec_prefix=\${prefix}
        libdir=\${exec_prefix}/lib
        includedir=\${prefix}/include/SDL2

        Name: SDL2_ttf
        Description: ttf library for Simple DirectMedia Layer with FreeType 2 support
        Version: 2.22.0
        Requires: sdl2 >= 2.0.0
        Libs: -L\${libdir} -lSDL2_ttf
        Cflags: -I\${includedir} -D_SDL_main_h
        EOF

    - name: Cache Stack dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Roaming\stack
          ~\AppData\Local\Programs\stack
          .stack-work
        key: ${{ runner.os }}-stack-${{ hashFiles('stack.yaml', 'shark-game.cabal') }}
        restore-keys: |
          ${{ runner.os }}-stack-

    - name: Build
      shell: bash
      run: |
        SDL_DIR=$(cygpath -w "$PWD/sdl2-install")
        export PKG_CONFIG_PATH="$PWD/sdl2-install/lib/pkgconfig:$PKG_CONFIG_PATH"
        export PATH="$PWD/sdl2-install/bin:$PATH"
        stack build --copy-bins --local-bin-path . \
          --flag sdl2:-pkgconfig \
          --flag sdl2-image:-pkgconfig \
          --extra-include-dirs="$SDL_DIR/include/SDL2" \
          --extra-include-dirs="$SDL_DIR/include" \
          --extra-lib-dirs="$SDL_DIR/lib" \
          --ghc-options="-D_SDL_main_h"

    - name: Copy DLLs
      shell: bash
      run: |
        cp sdl2-install/bin/*.dll .
        ls -la *.dll *.exe

    - uses: actions/upload-artifact@v4
      with:
        name: shark-game-windows
        path: |
          *.exe
          *.dll
